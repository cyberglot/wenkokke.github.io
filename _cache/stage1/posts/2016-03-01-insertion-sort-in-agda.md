---
title        : "Insertion sort in Agda"
date         : 2016-03-01 12:00:00
tags         : [agda]
extra-script : [agda-extra-script.html]
---

<!--
<pre class="Agda"><a id="160" class="Keyword">module</a> <a id="167" href="2016-03-01-insertion-sort-in-agda.html" class="Module">2016-03-01-insertion-sort-in-agda</a> <a id="201" class="Keyword">where</a>
</pre>-->

I wrote this code a long time ago, and verifiying the correctness of some sorting algorithm is pretty much *the* standard “Hello World! I can Agda!” blog post---well, that and implementing the λ-calculus---but I really wanted an excuse to test my Jekyll/Agda integration…

<!--more-->

Now, the version of insertion sort that I will write in this blog post will be *correct by construction*. By this I mean that I will implemented insertion sort as a function from lists to ordered lists, where the type of ordered lists only contains ordered lists. There are some concerns about whether this style of programming is the right way to go. If you read a lot of Coq code, you will notice that Coq programmers often implement functions without *any* guarantees---e.g. they would implement insertion sort as a function from lists to lists---and then prove the function's properties separately. Personally, I have found that this style can lead to very clumsy code, but there are good arguments to be made for its naive efficiency, both in terms of time and space---if you don't need some property, you don't have to compute its proof!

I'm getting carried away… Well, one last announcement in the public interest: This post is written in literate Agda, and I've gone through the effort of using the Agda hilighter. This means that all functions and module names have links to their definitions---be it within the post, or in the Agda standard library!

Obligatory “this is literate code, here are my imports.”

<pre class="Agda"><a id="1726" class="Keyword">open</a> <a id="1731" class="Keyword">import</a> <a id="1738" href="Level.html" class="Module">Level</a>            <a id="1755" class="Keyword">using</a> <a id="1761" class="Symbol">(</a><a id="1762" href="Agda.Primitive.html#810" class="Primitive Operator">_⊔_</a><a id="1765" class="Symbol">)</a>
<a id="1767" class="Keyword">open</a> <a id="1772" class="Keyword">import</a> <a id="1779" href="Data.Vec.html" class="Module">Data.Vec</a>         <a id="1796" class="Keyword">using</a> <a id="1802" class="Symbol">(</a><a id="1803" href="Data.Vec.Base.html#998" class="Datatype">Vec</a><a id="1806" class="Symbol">;</a> <a id="1808" href="Data.Vec.Base.html#1034" class="InductiveConstructor">[]</a><a id="1810" class="Symbol">;</a> <a id="1812" href="Data.Vec.Base.html#1053" class="InductiveConstructor Operator">_∷_</a><a id="1815" class="Symbol">)</a>
<a id="1817" class="Keyword">open</a> <a id="1822" class="Keyword">import</a> <a id="1829" href="Data.Nat.html" class="Module">Data.Nat</a>         <a id="1846" class="Keyword">using</a> <a id="1852" class="Symbol">(</a><a id="1853" href="Agda.Builtin.Nat.html#192" class="Datatype">ℕ</a><a id="1854" class="Symbol">;</a> <a id="1856" href="Agda.Builtin.Nat.html#210" class="InductiveConstructor">zero</a><a id="1860" class="Symbol">;</a> <a id="1862" href="Agda.Builtin.Nat.html#223" class="InductiveConstructor">suc</a><a id="1865" class="Symbol">)</a>
<a id="1867" class="Keyword">open</a> <a id="1872" class="Keyword">import</a> <a id="1879" href="Data.Sum.html" class="Module">Data.Sum</a>         <a id="1896" class="Keyword">using</a> <a id="1902" class="Symbol">(</a><a id="1903" href="Data.Sum.Base.html#734" class="Datatype Operator">_⊎_</a><a id="1906" class="Symbol">;</a> <a id="1908" href="Data.Sum.Base.html#784" class="InductiveConstructor">inj₁</a><a id="1912" class="Symbol">;</a> <a id="1914" href="Data.Sum.Base.html#809" class="InductiveConstructor">inj₂</a><a id="1918" class="Symbol">)</a>
<a id="1920" class="Keyword">open</a> <a id="1925" class="Keyword">import</a> <a id="1932" href="Data.Product.html" class="Module">Data.Product</a>     <a id="1949" class="Keyword">using</a> <a id="1955" class="Symbol">(</a><a id="1956" href="Data.Product.html#1369" class="Function">∃</a><a id="1957" class="Symbol">;</a> <a id="1959" href="Agda.Builtin.Sigma.html#236" class="InductiveConstructor Operator">_,_</a><a id="1962" class="Symbol">;</a> <a id="1964" href="Agda.Builtin.Sigma.html#252" class="Field">proj₁</a><a id="1969" class="Symbol">;</a> <a id="1971" href="Agda.Builtin.Sigma.html#264" class="Field">proj₂</a><a id="1976" class="Symbol">)</a>
<a id="1978" class="Keyword">open</a> <a id="1983" class="Keyword">import</a> <a id="1990" href="Data.Empty.html" class="Module">Data.Empty</a>       <a id="2007" class="Keyword">using</a> <a id="2013" class="Symbol">(</a><a id="2014" href="Data.Empty.html#628" class="Function">⊥-elim</a><a id="2020" class="Symbol">)</a>
<a id="2022" class="Keyword">open</a> <a id="2027" class="Keyword">import</a> <a id="2034" href="Relation.Nullary.html" class="Module">Relation.Nullary</a> <a id="2051" class="Keyword">using</a> <a id="2057" class="Symbol">(</a><a id="2058" href="Relation.Nullary.html#656" class="Function Operator">¬_</a><a id="2060" class="Symbol">;</a> <a id="2062" href="Relation.Nullary.html#1511" class="Record">Dec</a><a id="2065" class="Symbol">;</a> <a id="2067" href="Relation.Nullary.html#1648" class="InductiveConstructor">yes</a><a id="2070" class="Symbol">;</a> <a id="2072" href="Relation.Nullary.html#1685" class="InductiveConstructor">no</a><a id="2074" class="Symbol">)</a>
<a id="2076" class="Keyword">open</a> <a id="2081" class="Keyword">import</a> <a id="2088" href="Relation.Binary.html" class="Module">Relation.Binary</a>
<a id="2104" class="Keyword">open</a> <a id="2109" class="Keyword">import</a> <a id="2116" href="Relation.Binary.PropositionalEquality.html" class="Module">Relation.Binary.PropositionalEquality</a>
</pre>
So the first question is "What do we want to sort?" The boring answer would be "lists of integers", but let's be a little bit more general. We can sort anything that forms a *decidable, total order*. Basically, this means three things:

  - we have some type A;
  - for any x and y of type A, we have a *type* of orderings between
    them, which we write as `x ≤ y`;
  - we can actually get that ordering using `x ≤? y` or `total x y`.

Below, we define our module to work for any decidable total order, and we unpack that order. If you have a look at `≤?` and `total`, you'll notice that they do slightly different things. For some x and y, `x ≤? y` will tell you whether or not `x ≤ y`, whereas `total` will tell you whether it is `x ≤ y` or `y ≤ x`.

<pre class="Agda"><a id="2918" class="Keyword">module</a> <a id="InsertionSort"></a><a id="2925" href="2016-03-01-insertion-sort-in-agda.html#2925" class="Module">InsertionSort</a> <a id="2939" class="Symbol">{</a><a id="2940" href="2016-03-01-insertion-sort-in-agda.html#2940" class="Bound">c</a> <a id="2942" href="2016-03-01-insertion-sort-in-agda.html#2942" class="Bound">ℓ₁</a> <a id="2945" href="2016-03-01-insertion-sort-in-agda.html#2945" class="Bound">ℓ₂</a><a id="2947" class="Symbol">}</a> <a id="2949" class="Symbol">{{</a><a id="2951" href="2016-03-01-insertion-sort-in-agda.html#2951" class="Bound">Ord</a> <a id="2955" class="Symbol">:</a> <a id="2957" href="Relation.Binary.Bundles.html#6007" class="Record">DecTotalOrder</a> <a id="2971" href="2016-03-01-insertion-sort-in-agda.html#2940" class="Bound">c</a> <a id="2973" href="2016-03-01-insertion-sort-in-agda.html#2942" class="Bound">ℓ₁</a> <a id="2976" href="2016-03-01-insertion-sort-in-agda.html#2945" class="Bound">ℓ₂</a><a id="2978" class="Symbol">}}</a> <a id="2981" class="Keyword">where</a>

  <a id="2990" class="Keyword">open</a> <a id="2995" href="Relation.Binary.Bundles.html#6007" class="Module">DecTotalOrder</a> <a id="3009" class="Symbol">{{…}}</a>
    <a id="3019" class="Keyword">using</a> <a id="3025" class="Symbol">(</a><a id="3026" href="Relation.Binary.Bundles.html#6156" class="Field Operator">_≤_</a><a id="3029" class="Symbol">;</a> <a id="3031" href="Relation.Binary.Structures.html#5772" class="Function Operator">_≤?_</a><a id="3035" class="Symbol">;</a> <a id="3037" href="Relation.Binary.Structures.html#5404" class="Function">total</a><a id="3042" class="Symbol">)</a>
    <a id="3048" class="Keyword">renaming</a> <a id="3057" class="Symbol">(</a><a id="3058" href="Relation.Binary.Structures.html#2361" class="Function">trans</a> <a id="3064" class="Symbol">to</a> <a id="3067" class="Function">≤-trans</a><a id="3074" class="Symbol">)</a>
  <a id="InsertionSort.A"></a><a id="3078" href="2016-03-01-insertion-sort-in-agda.html#3078" class="Function">A</a> <a id="3080" class="Symbol">=</a> <a id="3082" href="Relation.Binary.Bundles.html#6091" class="Field">DecTotalOrder.Carrier</a> <a id="3104" href="2016-03-01-insertion-sort-in-agda.html#2951" class="Bound">Ord</a>
</pre>
The type A is already ordered, but it would be incredibly convenient if it were also *bounded*---meaning that it has a value which is smaller than everything else, and a value which is bigger than everything else. Below, we define a wrapper for A which is bounded at the top by ⊤ and at the bottom by ⊥:

<pre class="Agda">  <a id="3424" class="Keyword">data</a> <a id="InsertionSort.Â"></a><a id="3429" href="2016-03-01-insertion-sort-in-agda.html#3429" class="Datatype">Â</a> <a id="3432" class="Symbol">:</a> <a id="3434" href="Agda.Primitive.html#326" class="Primitive">Set</a> <a id="3438" href="2016-03-01-insertion-sort-in-agda.html#2940" class="Bound">c</a> <a id="3440" class="Keyword">where</a>
    <a id="InsertionSort.Â.⊤"></a><a id="3450" href="2016-03-01-insertion-sort-in-agda.html#3450" class="InductiveConstructor">⊤</a> <a id="3452" class="Symbol">:</a> <a id="3454" href="2016-03-01-insertion-sort-in-agda.html#3429" class="Datatype">Â</a>
    <a id="InsertionSort.Â.⊥"></a><a id="3461" href="2016-03-01-insertion-sort-in-agda.html#3461" class="InductiveConstructor">⊥</a> <a id="3463" class="Symbol">:</a> <a id="3465" href="2016-03-01-insertion-sort-in-agda.html#3429" class="Datatype">Â</a>
    <a id="InsertionSort.Â.⟦_⟧"></a><a id="3472" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦_⟧</a> <a id="3476" class="Symbol">:</a> <a id="3478" href="2016-03-01-insertion-sort-in-agda.html#3078" class="Function">A</a> <a id="3480" class="Symbol">→</a> <a id="3482" href="2016-03-01-insertion-sort-in-agda.html#3429" class="Datatype">Â</a>
</pre>
We still need to encode the fact that ⊥ and ⊤ are in fact smaller and bigger than all other values. Below, we defined the order ≲ on bounded Â… where we simply state these facts as ⊥≲ and ≲⊤:

<pre class="Agda">  <a id="3690" class="Keyword">infix</a> <a id="3696" class="Number">4</a> <a id="3698" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">_≲_</a>

  <a id="3705" class="Keyword">data</a> <a id="InsertionSort._≲_"></a><a id="3710" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">_≲_</a> <a id="3714" class="Symbol">:</a> <a id="3716" href="Relation.Binary.Core.html#882" class="Function">Rel</a> <a id="3720" href="2016-03-01-insertion-sort-in-agda.html#3429" class="Datatype">Â</a> <a id="3723" class="Symbol">(</a><a id="3724" href="2016-03-01-insertion-sort-in-agda.html#2940" class="Bound">c</a> <a id="3726" href="Agda.Primitive.html#810" class="Primitive Operator">⊔</a> <a id="3728" href="2016-03-01-insertion-sort-in-agda.html#2945" class="Bound">ℓ₂</a><a id="3730" class="Symbol">)</a> <a id="3732" class="Keyword">where</a>
    <a id="InsertionSort._≲_.⊥≲"></a><a id="3742" href="2016-03-01-insertion-sort-in-agda.html#3742" class="InductiveConstructor">⊥≲</a> <a id="3745" class="Symbol">:</a> <a id="3747" class="Symbol">∀</a> <a id="3749" class="Symbol">{</a><a id="3750" href="2016-03-01-insertion-sort-in-agda.html#3750" class="Bound">x</a><a id="3751" class="Symbol">}</a> <a id="3753" class="Symbol">→</a> <a id="3755" href="2016-03-01-insertion-sort-in-agda.html#3461" class="InductiveConstructor">⊥</a> <a id="3757" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="3759" href="2016-03-01-insertion-sort-in-agda.html#3750" class="Bound">x</a>
    <a id="InsertionSort._≲_.≲⊤"></a><a id="3765" href="2016-03-01-insertion-sort-in-agda.html#3765" class="InductiveConstructor">≲⊤</a> <a id="3768" class="Symbol">:</a> <a id="3770" class="Symbol">∀</a> <a id="3772" class="Symbol">{</a><a id="3773" href="2016-03-01-insertion-sort-in-agda.html#3773" class="Bound">x</a><a id="3774" class="Symbol">}</a> <a id="3776" class="Symbol">→</a> <a id="3778" href="2016-03-01-insertion-sort-in-agda.html#3773" class="Bound">x</a> <a id="3780" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="3782" href="2016-03-01-insertion-sort-in-agda.html#3450" class="InductiveConstructor">⊤</a>
    <a id="InsertionSort._≲_.≤-lift"></a><a id="3788" href="2016-03-01-insertion-sort-in-agda.html#3788" class="InductiveConstructor">≤-lift</a> <a id="3795" class="Symbol">:</a> <a id="3797" class="Symbol">∀</a> <a id="3799" class="Symbol">{</a><a id="3800" href="2016-03-01-insertion-sort-in-agda.html#3800" class="Bound">x</a> <a id="3802" href="2016-03-01-insertion-sort-in-agda.html#3802" class="Bound">y</a><a id="3803" class="Symbol">}</a> <a id="3805" class="Symbol">→</a> <a id="3807" href="2016-03-01-insertion-sort-in-agda.html#3800" class="Bound">x</a> <a id="3809" href="Relation.Binary.Bundles.html#6156" class="Field Operator">≤</a> <a id="3811" href="2016-03-01-insertion-sort-in-agda.html#3802" class="Bound">y</a> <a id="3813" class="Symbol">→</a> <a id="3815" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="3817" href="2016-03-01-insertion-sort-in-agda.html#3800" class="Bound">x</a> <a id="3819" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="3821" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="3823" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="3825" href="2016-03-01-insertion-sort-in-agda.html#3802" class="Bound">y</a> <a id="3827" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a>
</pre>
Note that with the last constructor, we can lift the order of any two values in A into ≲. However, if we only have a proof of ≰, then the lifting is slightly more involved. Therefore, we define a function which does this for us:

<pre class="Agda">  <a id="InsertionSort.≰-lift"></a><a id="4070" href="2016-03-01-insertion-sort-in-agda.html#4070" class="Function">≰-lift</a> <a id="4077" class="Symbol">:</a> <a id="4079" class="Symbol">∀</a> <a id="4081" class="Symbol">{</a><a id="4082" href="2016-03-01-insertion-sort-in-agda.html#4082" class="Bound">x</a> <a id="4084" href="2016-03-01-insertion-sort-in-agda.html#4084" class="Bound">y</a><a id="4085" class="Symbol">}</a> <a id="4087" class="Symbol">→</a> <a id="4089" href="Relation.Nullary.html#656" class="Function Operator">¬</a> <a id="4091" class="Symbol">(</a><a id="4092" href="2016-03-01-insertion-sort-in-agda.html#4084" class="Bound">y</a> <a id="4094" href="Relation.Binary.Bundles.html#6156" class="Field Operator">≤</a> <a id="4096" href="2016-03-01-insertion-sort-in-agda.html#4082" class="Bound">x</a><a id="4097" class="Symbol">)</a> <a id="4099" class="Symbol">→</a> <a id="4101" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4103" href="2016-03-01-insertion-sort-in-agda.html#4082" class="Bound">x</a> <a id="4105" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="4107" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="4109" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4111" href="2016-03-01-insertion-sort-in-agda.html#4084" class="Bound">y</a> <a id="4113" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a>
  <a id="4117" href="2016-03-01-insertion-sort-in-agda.html#4070" class="Function">≰-lift</a> <a id="4124" class="Symbol">{</a><a id="4125" href="2016-03-01-insertion-sort-in-agda.html#4125" class="Bound">x</a><a id="4126" class="Symbol">}</a> <a id="4128" class="Symbol">{</a><a id="4129" href="2016-03-01-insertion-sort-in-agda.html#4129" class="Bound">y</a><a id="4130" class="Symbol">}</a> <a id="4132" href="2016-03-01-insertion-sort-in-agda.html#4132" class="Bound">y≰x</a> <a id="4136" class="Keyword">with</a> <a id="4141" href="Relation.Binary.Structures.html#5404" class="Function">total</a> <a id="4147" href="2016-03-01-insertion-sort-in-agda.html#4125" class="Bound">x</a> <a id="4149" href="2016-03-01-insertion-sort-in-agda.html#4129" class="Bound">y</a>
  <a id="4153" href="2016-03-01-insertion-sort-in-agda.html#4070" class="Function">≰-lift</a> <a id="4160" href="2016-03-01-insertion-sort-in-agda.html#4160" class="Bound">y≰x</a> <a id="4164" class="Symbol">|</a> <a id="4166" href="Data.Sum.Base.html#784" class="InductiveConstructor">inj₁</a> <a id="4171" href="2016-03-01-insertion-sort-in-agda.html#4171" class="Bound">x≤y</a> <a id="4175" class="Symbol">=</a> <a id="4177" href="2016-03-01-insertion-sort-in-agda.html#3788" class="InductiveConstructor">≤-lift</a> <a id="4184" href="2016-03-01-insertion-sort-in-agda.html#4171" class="Bound">x≤y</a>
  <a id="4190" href="2016-03-01-insertion-sort-in-agda.html#4070" class="Function">≰-lift</a> <a id="4197" href="2016-03-01-insertion-sort-in-agda.html#4197" class="Bound">y≰x</a> <a id="4201" class="Symbol">|</a> <a id="4203" href="Data.Sum.Base.html#809" class="InductiveConstructor">inj₂</a> <a id="4208" href="2016-03-01-insertion-sort-in-agda.html#4208" class="Bound">y≤x</a> <a id="4212" class="Symbol">=</a> <a id="4214" href="Data.Empty.html#628" class="Function">⊥-elim</a> <a id="4221" class="Symbol">(</a><a id="4222" href="2016-03-01-insertion-sort-in-agda.html#4197" class="Bound">y≰x</a> <a id="4226" href="2016-03-01-insertion-sort-in-agda.html#4208" class="Bound">y≤x</a><a id="4229" class="Symbol">)</a>
</pre>
Another thing we can do with two values of type Â is compute their *minimum*. This is one example where we deviate from *correctness by construction*: we define minimum function ⊓, and only then prove its correctness:

<pre class="Agda">  <a id="4462" class="Keyword">infix</a> <a id="4468" class="Number">5</a> <a id="4470" href="2016-03-01-insertion-sort-in-agda.html#4477" class="Function Operator">_⊓_</a>

  <a id="InsertionSort._⊓_"></a><a id="4477" href="2016-03-01-insertion-sort-in-agda.html#4477" class="Function Operator">_⊓_</a> <a id="4481" class="Symbol">:</a> <a id="4483" href="2016-03-01-insertion-sort-in-agda.html#3429" class="Datatype">Â</a> <a id="4486" class="Symbol">→</a> <a id="4488" href="2016-03-01-insertion-sort-in-agda.html#3429" class="Datatype">Â</a> <a id="4491" class="Symbol">→</a> <a id="4493" href="2016-03-01-insertion-sort-in-agda.html#3429" class="Datatype">Â</a>
  <a id="4498" href="2016-03-01-insertion-sort-in-agda.html#3450" class="InductiveConstructor">⊤</a> <a id="4500" href="2016-03-01-insertion-sort-in-agda.html#4477" class="Function Operator">⊓</a> <a id="4502" href="2016-03-01-insertion-sort-in-agda.html#4502" class="Bound">y</a> <a id="4504" class="Symbol">=</a> <a id="4506" href="2016-03-01-insertion-sort-in-agda.html#4502" class="Bound">y</a>
  <a id="4510" href="2016-03-01-insertion-sort-in-agda.html#3461" class="InductiveConstructor">⊥</a> <a id="4512" href="2016-03-01-insertion-sort-in-agda.html#4477" class="Function Operator">⊓</a> <a id="4514" class="Symbol">_</a> <a id="4516" class="Symbol">=</a> <a id="4518" href="2016-03-01-insertion-sort-in-agda.html#3461" class="InductiveConstructor">⊥</a>
  <a id="4522" href="2016-03-01-insertion-sort-in-agda.html#4522" class="CatchallClause Bound">x</a><a id="4523" class="CatchallClause"> </a><a id="4524" href="2016-03-01-insertion-sort-in-agda.html#4477" class="CatchallClause Function Operator">⊓</a><a id="4525" class="CatchallClause"> </a><a id="4526" href="2016-03-01-insertion-sort-in-agda.html#3450" class="CatchallClause InductiveConstructor">⊤</a> <a id="4528" class="Symbol">=</a> <a id="4530" href="2016-03-01-insertion-sort-in-agda.html#4522" class="Bound">x</a>
  <a id="4534" class="CatchallClause Symbol">_</a><a id="4535" class="CatchallClause"> </a><a id="4536" href="2016-03-01-insertion-sort-in-agda.html#4477" class="CatchallClause Function Operator">⊓</a><a id="4537" class="CatchallClause"> </a><a id="4538" href="2016-03-01-insertion-sort-in-agda.html#3461" class="CatchallClause InductiveConstructor">⊥</a> <a id="4540" class="Symbol">=</a> <a id="4542" href="2016-03-01-insertion-sort-in-agda.html#3461" class="InductiveConstructor">⊥</a>
  <a id="4546" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4548" href="2016-03-01-insertion-sort-in-agda.html#4548" class="Bound">x</a> <a id="4550" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="4552" href="2016-03-01-insertion-sort-in-agda.html#4477" class="Function Operator">⊓</a> <a id="4554" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4556" href="2016-03-01-insertion-sort-in-agda.html#4556" class="Bound">y</a> <a id="4558" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="4560" class="Keyword">with</a> <a id="4565" href="2016-03-01-insertion-sort-in-agda.html#4548" class="Bound">x</a> <a id="4567" href="Relation.Binary.Structures.html#5772" class="Function Operator">≤?</a> <a id="4570" href="2016-03-01-insertion-sort-in-agda.html#4556" class="Bound">y</a>
  <a id="4574" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4576" href="2016-03-01-insertion-sort-in-agda.html#4576" class="Bound">x</a> <a id="4578" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="4580" href="2016-03-01-insertion-sort-in-agda.html#4477" class="Function Operator">⊓</a> <a id="4582" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4584" href="2016-03-01-insertion-sort-in-agda.html#4584" class="Bound">y</a> <a id="4586" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="4588" class="Symbol">|</a> <a id="4590" href="Relation.Nullary.html#1648" class="InductiveConstructor">yes</a> <a id="4594" href="2016-03-01-insertion-sort-in-agda.html#4594" class="Bound">x≤y</a> <a id="4598" class="Symbol">=</a> <a id="4600" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4602" href="2016-03-01-insertion-sort-in-agda.html#4576" class="Bound">x</a> <a id="4604" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a>
  <a id="4608" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4610" href="2016-03-01-insertion-sort-in-agda.html#4610" class="Bound">x</a> <a id="4612" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="4614" href="2016-03-01-insertion-sort-in-agda.html#4477" class="Function Operator">⊓</a> <a id="4616" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4618" href="2016-03-01-insertion-sort-in-agda.html#4618" class="Bound">y</a> <a id="4620" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="4622" class="Symbol">|</a> <a id="4624" href="Relation.Nullary.html#1685" class="InductiveConstructor">no</a>  <a id="4628" href="2016-03-01-insertion-sort-in-agda.html#4628" class="Bound">x&gt;y</a> <a id="4632" class="Symbol">=</a> <a id="4634" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4636" href="2016-03-01-insertion-sort-in-agda.html#4618" class="Bound">y</a> <a id="4638" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a>

  <a id="InsertionSort.⊓-conserves-≲"></a><a id="4643" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="4657" class="Symbol">:</a> <a id="4659" class="Symbol">∀</a> <a id="4661" class="Symbol">{</a><a id="4662" href="2016-03-01-insertion-sort-in-agda.html#4662" class="Bound">x</a> <a id="4664" href="2016-03-01-insertion-sort-in-agda.html#4664" class="Bound">y</a> <a id="4666" href="2016-03-01-insertion-sort-in-agda.html#4666" class="Bound">z</a><a id="4667" class="Symbol">}</a> <a id="4669" class="Symbol">→</a> <a id="4671" href="2016-03-01-insertion-sort-in-agda.html#4662" class="Bound">x</a> <a id="4673" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="4675" href="2016-03-01-insertion-sort-in-agda.html#4664" class="Bound">y</a> <a id="4677" class="Symbol">→</a> <a id="4679" href="2016-03-01-insertion-sort-in-agda.html#4662" class="Bound">x</a> <a id="4681" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="4683" href="2016-03-01-insertion-sort-in-agda.html#4666" class="Bound">z</a> <a id="4685" class="Symbol">→</a> <a id="4687" href="2016-03-01-insertion-sort-in-agda.html#4662" class="Bound">x</a> <a id="4689" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="4691" href="2016-03-01-insertion-sort-in-agda.html#4664" class="Bound">y</a> <a id="4693" href="2016-03-01-insertion-sort-in-agda.html#4477" class="Function Operator">⊓</a> <a id="4695" href="2016-03-01-insertion-sort-in-agda.html#4666" class="Bound">z</a>
  <a id="4699" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="4713" class="Symbol">{</a><a id="4714" href="2016-03-01-insertion-sort-in-agda.html#4714" class="Bound">x</a><a id="4715" class="Symbol">}</a> <a id="4717" class="Symbol">{</a><a id="4718" href="2016-03-01-insertion-sort-in-agda.html#3450" class="InductiveConstructor">⊤</a><a id="4719" class="Symbol">}</a> <a id="4721" class="Symbol">{_}</a> <a id="4725" class="Symbol">_</a> <a id="4727" href="2016-03-01-insertion-sort-in-agda.html#4727" class="Bound">q</a> <a id="4729" class="Symbol">=</a> <a id="4731" href="2016-03-01-insertion-sort-in-agda.html#4727" class="Bound">q</a>
  <a id="4735" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="4749" class="Symbol">{</a><a id="4750" href="2016-03-01-insertion-sort-in-agda.html#4750" class="Bound">x</a><a id="4751" class="Symbol">}</a> <a id="4753" class="Symbol">{</a><a id="4754" href="2016-03-01-insertion-sort-in-agda.html#3461" class="InductiveConstructor">⊥</a><a id="4755" class="Symbol">}</a> <a id="4757" class="Symbol">{_}</a> <a id="4761" href="2016-03-01-insertion-sort-in-agda.html#4761" class="Bound">p</a> <a id="4763" class="Symbol">_</a> <a id="4765" class="Symbol">=</a> <a id="4767" href="2016-03-01-insertion-sort-in-agda.html#4761" class="Bound">p</a>
  <a id="4771" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="4785" class="Symbol">{</a><a id="4786" href="2016-03-01-insertion-sort-in-agda.html#4786" class="Bound">x</a><a id="4787" class="Symbol">}</a> <a id="4789" class="Symbol">{</a><a id="4790" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4792" class="Symbol">_</a> <a id="4794" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a><a id="4795" class="Symbol">}</a> <a id="4797" class="Symbol">{</a><a id="4798" href="2016-03-01-insertion-sort-in-agda.html#3450" class="InductiveConstructor">⊤</a><a id="4799" class="Symbol">}</a> <a id="4801" href="2016-03-01-insertion-sort-in-agda.html#4801" class="Bound">p</a> <a id="4803" class="Symbol">_</a> <a id="4805" class="Symbol">=</a> <a id="4807" href="2016-03-01-insertion-sort-in-agda.html#4801" class="Bound">p</a>
  <a id="4811" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="4825" class="Symbol">{</a><a id="4826" href="2016-03-01-insertion-sort-in-agda.html#4826" class="Bound">x</a><a id="4827" class="Symbol">}</a> <a id="4829" class="Symbol">{</a><a id="4830" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4832" class="Symbol">_</a> <a id="4834" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a><a id="4835" class="Symbol">}</a> <a id="4837" class="Symbol">{</a><a id="4838" href="2016-03-01-insertion-sort-in-agda.html#3461" class="InductiveConstructor">⊥</a><a id="4839" class="Symbol">}</a> <a id="4841" class="Symbol">_</a> <a id="4843" href="2016-03-01-insertion-sort-in-agda.html#4843" class="Bound">q</a> <a id="4845" class="Symbol">=</a> <a id="4847" href="2016-03-01-insertion-sort-in-agda.html#4843" class="Bound">q</a>
  <a id="4851" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="4865" class="Symbol">{</a><a id="4866" href="2016-03-01-insertion-sort-in-agda.html#4866" class="Bound">x</a><a id="4867" class="Symbol">}</a> <a id="4869" class="Symbol">{</a><a id="4870" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4872" href="2016-03-01-insertion-sort-in-agda.html#4872" class="Bound">y</a> <a id="4874" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a><a id="4875" class="Symbol">}</a> <a id="4877" class="Symbol">{</a><a id="4878" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4880" href="2016-03-01-insertion-sort-in-agda.html#4880" class="Bound">z</a> <a id="4882" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a><a id="4883" class="Symbol">}</a> <a id="4885" href="2016-03-01-insertion-sort-in-agda.html#4885" class="Bound">p</a> <a id="4887" href="2016-03-01-insertion-sort-in-agda.html#4887" class="Bound">q</a> <a id="4889" class="Keyword">with</a> <a id="4894" href="2016-03-01-insertion-sort-in-agda.html#4872" class="Bound">y</a> <a id="4896" href="Relation.Binary.Structures.html#5772" class="Function Operator">≤?</a> <a id="4899" href="2016-03-01-insertion-sort-in-agda.html#4880" class="Bound">z</a>
  <a id="4903" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="4917" class="Symbol">{</a><a id="4918" href="2016-03-01-insertion-sort-in-agda.html#4918" class="Bound">x</a><a id="4919" class="Symbol">}</a> <a id="4921" class="Symbol">{</a><a id="4922" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4924" href="2016-03-01-insertion-sort-in-agda.html#4924" class="Bound">y</a> <a id="4926" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a><a id="4927" class="Symbol">}</a> <a id="4929" class="Symbol">{</a><a id="4930" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4932" href="2016-03-01-insertion-sort-in-agda.html#4932" class="Bound">z</a> <a id="4934" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a><a id="4935" class="Symbol">}</a> <a id="4937" href="2016-03-01-insertion-sort-in-agda.html#4937" class="Bound">p</a> <a id="4939" class="Symbol">_</a> <a id="4941" class="Symbol">|</a> <a id="4943" href="Relation.Nullary.html#1648" class="InductiveConstructor">yes</a> <a id="4947" href="2016-03-01-insertion-sort-in-agda.html#4947" class="Bound">y≤z</a> <a id="4951" class="Symbol">=</a> <a id="4953" href="2016-03-01-insertion-sort-in-agda.html#4937" class="Bound">p</a>
  <a id="4957" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="4971" class="Symbol">{</a><a id="4972" href="2016-03-01-insertion-sort-in-agda.html#4972" class="Bound">x</a><a id="4973" class="Symbol">}</a> <a id="4975" class="Symbol">{</a><a id="4976" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4978" href="2016-03-01-insertion-sort-in-agda.html#4978" class="Bound">y</a> <a id="4980" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a><a id="4981" class="Symbol">}</a> <a id="4983" class="Symbol">{</a><a id="4984" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="4986" href="2016-03-01-insertion-sort-in-agda.html#4986" class="Bound">z</a> <a id="4988" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a><a id="4989" class="Symbol">}</a> <a id="4991" class="Symbol">_</a> <a id="4993" href="2016-03-01-insertion-sort-in-agda.html#4993" class="Bound">q</a> <a id="4995" class="Symbol">|</a> <a id="4997" href="Relation.Nullary.html#1685" class="InductiveConstructor">no</a>  <a id="5001" href="2016-03-01-insertion-sort-in-agda.html#5001" class="Bound">y≰z</a> <a id="5005" class="Symbol">=</a> <a id="5007" href="2016-03-01-insertion-sort-in-agda.html#4993" class="Bound">q</a>
</pre>
Insertion sort has rather complicated invariants. If we were implementing mergesort, that we could define ordered lists as lists in which every element is larger than those before it… But alas! Such a crude analysis won't work for insertion sort! In fact, the only guarantee that insertion sort gives us is that after one "bubble"---one iteration over the list---the *last* element is sorted… and that after *k* insertions, the last *k* elements are sorted…

So to implement insertion sort, we're going to need some way to represent lists of which the last *k* elements are sorted. In fact, because it's easier to implement, we're going to go with an encoding which ensures us that at most the *first* *k* elements are still *unsorted*.

The `OVec` datatype below has three parameters: *l*, *n* and *k*. The first of these is the lower bound… that is to say, of the sorted part, the smallest element is *l*. The second is the length of the list. One question that we've avoided so far is the question "What sort of things can go wrong in a sorting algorithm?" Obviously, the first thing that comes to mind is "it doens't sort", but some other problems that it could have is that it can *delete* elements, or *copy* elements. While keeping track of the length doesn't solve *all* of those problems---if we delete as much as we copy, we don't change the length---but it's a good starting point. The last, *k*, is the number of still unsorted elements at the beginning of the list.

There are three ways to construct an `OVec`:

  - we have the empty list, which has zero length, and zero unsorted elements… and a sorted segment of length zero with lower bound ⊤---this was the main reason to introduce Â;
  - we can add an element to the sorted segment of the list---as long as there aren't any unsorted elements in there yet---but we will have to prove that the new element is actually smaller than the current lower bound;
  - and finally, we can forgo all sorting, and just add some unsorted elements to the front of the list.

<pre class="Agda">  <a id="7050" class="Keyword">data</a> <a id="InsertionSort.OVec"></a><a id="7055" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="7060" class="Symbol">:</a> <a id="7062" class="Symbol">(</a><a id="7063" href="2016-03-01-insertion-sort-in-agda.html#7063" class="Bound">l</a> <a id="7065" class="Symbol">:</a> <a id="7067" href="2016-03-01-insertion-sort-in-agda.html#3429" class="Datatype">Â</a><a id="7069" class="Symbol">)</a> <a id="7071" class="Symbol">(</a><a id="7072" href="2016-03-01-insertion-sort-in-agda.html#7072" class="Bound">n</a> <a id="7074" href="2016-03-01-insertion-sort-in-agda.html#7074" class="Bound">k</a> <a id="7076" class="Symbol">:</a> <a id="7078" href="Agda.Builtin.Nat.html#192" class="Datatype">ℕ</a><a id="7079" class="Symbol">)</a> <a id="7081" class="Symbol">→</a> <a id="7083" href="Agda.Primitive.html#326" class="Primitive">Set</a> <a id="7087" class="Symbol">(</a><a id="7088" href="2016-03-01-insertion-sort-in-agda.html#2940" class="Bound">c</a> <a id="7090" href="Agda.Primitive.html#810" class="Primitive Operator">⊔</a> <a id="7092" href="2016-03-01-insertion-sort-in-agda.html#2945" class="Bound">ℓ₂</a><a id="7094" class="Symbol">)</a> <a id="7096" class="Keyword">where</a>

    <a id="InsertionSort.OVec.[]"></a><a id="7107" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a>     <a id="7114" class="Symbol">:</a> <a id="7116" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="7121" href="2016-03-01-insertion-sort-in-agda.html#3450" class="InductiveConstructor">⊤</a> <a id="7123" class="Number">0</a> <a id="7125" class="Number">0</a>

    <a id="InsertionSort.OVec._∷_by_"></a><a id="7132" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">_∷_by_</a> <a id="7139" class="Symbol">:</a> <a id="7141" class="Symbol">∀</a> <a id="7143" class="Symbol">{</a><a id="7144" href="2016-03-01-insertion-sort-in-agda.html#7144" class="Bound">l</a> <a id="7146" href="2016-03-01-insertion-sort-in-agda.html#7146" class="Bound">n</a><a id="7147" class="Symbol">}</a> <a id="7149" class="Symbol">(</a><a id="7150" href="2016-03-01-insertion-sort-in-agda.html#7150" class="Bound">x</a> <a id="7152" class="Symbol">:</a> <a id="7154" href="2016-03-01-insertion-sort-in-agda.html#3078" class="Function">A</a><a id="7155" class="Symbol">)</a> <a id="7157" class="Symbol">(</a><a id="7158" href="2016-03-01-insertion-sort-in-agda.html#7158" class="Bound">xs</a> <a id="7161" class="Symbol">:</a> <a id="7163" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="7168" href="2016-03-01-insertion-sort-in-agda.html#7144" class="Bound">l</a> <a id="7170" href="2016-03-01-insertion-sort-in-agda.html#7146" class="Bound">n</a> <a id="7172" class="Number">0</a><a id="7173" class="Symbol">)</a>
           <a id="7186" class="Symbol">→</a> <a id="7188" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="7190" href="2016-03-01-insertion-sort-in-agda.html#7150" class="Bound">x</a> <a id="7192" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="7194" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="7196" href="2016-03-01-insertion-sort-in-agda.html#7144" class="Bound">l</a> <a id="7198" class="Symbol">→</a> <a id="7200" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="7205" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="7207" href="2016-03-01-insertion-sort-in-agda.html#7150" class="Bound">x</a> <a id="7209" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="7211" class="Symbol">(</a><a id="7212" href="Agda.Builtin.Nat.html#223" class="InductiveConstructor">suc</a> <a id="7216" href="2016-03-01-insertion-sort-in-agda.html#7146" class="Bound">n</a><a id="7217" class="Symbol">)</a> <a id="7219" class="Number">0</a>

    <a id="InsertionSort.OVec._∷_"></a><a id="7226" href="2016-03-01-insertion-sort-in-agda.html#7226" class="InductiveConstructor Operator">_∷_</a>    <a id="7233" class="Symbol">:</a> <a id="7235" class="Symbol">∀</a> <a id="7237" class="Symbol">{</a><a id="7238" href="2016-03-01-insertion-sort-in-agda.html#7238" class="Bound">l</a> <a id="7240" href="2016-03-01-insertion-sort-in-agda.html#7240" class="Bound">n</a> <a id="7242" href="2016-03-01-insertion-sort-in-agda.html#7242" class="Bound">k</a><a id="7243" class="Symbol">}</a> <a id="7245" class="Symbol">(</a><a id="7246" href="2016-03-01-insertion-sort-in-agda.html#7246" class="Bound">x</a> <a id="7248" class="Symbol">:</a> <a id="7250" href="2016-03-01-insertion-sort-in-agda.html#3078" class="Function">A</a><a id="7251" class="Symbol">)</a> <a id="7253" class="Symbol">(</a><a id="7254" href="2016-03-01-insertion-sort-in-agda.html#7254" class="Bound">xs</a> <a id="7257" class="Symbol">:</a> <a id="7259" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="7264" href="2016-03-01-insertion-sort-in-agda.html#7238" class="Bound">l</a> <a id="7266" href="2016-03-01-insertion-sort-in-agda.html#7240" class="Bound">n</a> <a id="7268" href="2016-03-01-insertion-sort-in-agda.html#7242" class="Bound">k</a><a id="7269" class="Symbol">)</a>
           <a id="7282" class="Symbol">→</a> <a id="7284" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="7289" href="2016-03-01-insertion-sort-in-agda.html#3461" class="InductiveConstructor">⊥</a> <a id="7291" class="Symbol">(</a><a id="7292" href="Agda.Builtin.Nat.html#223" class="InductiveConstructor">suc</a> <a id="7296" href="2016-03-01-insertion-sort-in-agda.html#7240" class="Bound">n</a><a id="7297" class="Symbol">)</a> <a id="7299" class="Symbol">(</a><a id="7300" href="Agda.Builtin.Nat.html#223" class="InductiveConstructor">suc</a> <a id="7304" href="2016-03-01-insertion-sort-in-agda.html#7242" class="Bound">k</a><a id="7305" class="Symbol">)</a>
</pre>
If we have a regular vector---a list which tracks its length---we can turn it into a k-ordered vector together with some lower bound. (This is the reason we're using vectors… if we were using lists, we'd have another existential with the lists length in it.) Our naive process of just inserting all elements in the vector as *unsorted* means that the lower bound will be either ⊤ or ⊥. And we can show that!

<pre class="Agda">  <a id="InsertionSort.fromVec"></a><a id="7727" href="2016-03-01-insertion-sort-in-agda.html#7727" class="Function">fromVec</a> <a id="7735" class="Symbol">:</a> <a id="7737" class="Symbol">∀</a> <a id="7739" class="Symbol">{</a><a id="7740" href="2016-03-01-insertion-sort-in-agda.html#7740" class="Bound">n</a><a id="7741" class="Symbol">}</a> <a id="7743" class="Symbol">→</a> <a id="7745" href="Data.Vec.Base.html#998" class="Datatype">Vec</a> <a id="7749" href="2016-03-01-insertion-sort-in-agda.html#3078" class="Function">A</a> <a id="7751" href="2016-03-01-insertion-sort-in-agda.html#7740" class="Bound">n</a> <a id="7753" class="Symbol">→</a> <a id="7755" href="Data.Product.html#1369" class="Function">∃</a> <a id="7757" class="Symbol">(λ</a> <a id="7760" href="2016-03-01-insertion-sort-in-agda.html#7760" class="Bound">l</a> <a id="7762" class="Symbol">→</a> <a id="7764" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="7769" href="2016-03-01-insertion-sort-in-agda.html#7760" class="Bound">l</a> <a id="7771" href="2016-03-01-insertion-sort-in-agda.html#7740" class="Bound">n</a> <a id="7773" href="2016-03-01-insertion-sort-in-agda.html#7740" class="Bound">n</a><a id="7774" class="Symbol">)</a>
  <a id="7778" href="2016-03-01-insertion-sort-in-agda.html#7727" class="Function">fromVec</a> <a id="7786" href="Data.Vec.Base.html#1034" class="InductiveConstructor">[]</a> <a id="7789" class="Symbol">=</a> <a id="7791" href="2016-03-01-insertion-sort-in-agda.html#3450" class="InductiveConstructor">⊤</a> <a id="7793" href="Agda.Builtin.Sigma.html#236" class="InductiveConstructor Operator">,</a> <a id="7795" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a>
  <a id="7800" href="2016-03-01-insertion-sort-in-agda.html#7727" class="Function">fromVec</a> <a id="7808" class="Symbol">(</a><a id="7809" href="2016-03-01-insertion-sort-in-agda.html#7809" class="Bound">x</a> <a id="7811" href="Data.Vec.Base.html#1053" class="InductiveConstructor Operator">∷</a> <a id="7813" href="2016-03-01-insertion-sort-in-agda.html#7813" class="Bound">xs</a><a id="7815" class="Symbol">)</a> <a id="7817" class="Symbol">=</a> <a id="7819" href="2016-03-01-insertion-sort-in-agda.html#3461" class="InductiveConstructor">⊥</a> <a id="7821" href="Agda.Builtin.Sigma.html#236" class="InductiveConstructor Operator">,</a> <a id="7823" href="2016-03-01-insertion-sort-in-agda.html#7809" class="Bound">x</a> <a id="7825" href="2016-03-01-insertion-sort-in-agda.html#7226" class="InductiveConstructor Operator">∷</a> <a id="7827" href="Agda.Builtin.Sigma.html#264" class="Field">proj₂</a> <a id="7833" class="Symbol">(</a><a id="7834" href="2016-03-01-insertion-sort-in-agda.html#7727" class="Function">fromVec</a> <a id="7842" href="2016-03-01-insertion-sort-in-agda.html#7813" class="Bound">xs</a><a id="7844" class="Symbol">)</a>

  <a id="InsertionSort.fromVec-⊤or⊥"></a><a id="7849" href="2016-03-01-insertion-sort-in-agda.html#7849" class="Function">fromVec-⊤or⊥</a> <a id="7862" class="Symbol">:</a> <a id="7864" class="Symbol">∀</a> <a id="7866" class="Symbol">{</a><a id="7867" href="2016-03-01-insertion-sort-in-agda.html#7867" class="Bound">n</a><a id="7868" class="Symbol">}</a> <a id="7870" class="Symbol">{</a><a id="7871" href="2016-03-01-insertion-sort-in-agda.html#7871" class="Bound">xs</a> <a id="7874" class="Symbol">:</a> <a id="7876" href="Data.Vec.Base.html#998" class="Datatype">Vec</a> <a id="7880" href="2016-03-01-insertion-sort-in-agda.html#3078" class="Function">A</a> <a id="7882" href="2016-03-01-insertion-sort-in-agda.html#7867" class="Bound">n</a><a id="7883" class="Symbol">}</a>
    <a id="7889" class="Symbol">→</a> <a id="7891" class="Keyword">let</a> <a id="7895" href="2016-03-01-insertion-sort-in-agda.html#7895" class="Bound">l</a> <a id="7897" class="Symbol">=</a> <a id="7899" href="Agda.Builtin.Sigma.html#252" class="Field">proj₁</a> <a id="7905" class="Symbol">(</a><a id="7906" href="2016-03-01-insertion-sort-in-agda.html#7727" class="Function">fromVec</a> <a id="7914" href="2016-03-01-insertion-sort-in-agda.html#7871" class="Bound">xs</a><a id="7916" class="Symbol">)</a> <a id="7918" class="Keyword">in</a> <a id="7921" href="2016-03-01-insertion-sort-in-agda.html#7895" class="Bound">l</a> <a id="7923" href="Agda.Builtin.Equality.html#151" class="Datatype Operator">≡</a> <a id="7925" href="2016-03-01-insertion-sort-in-agda.html#3450" class="InductiveConstructor">⊤</a> <a id="7927" href="Data.Sum.Base.html#734" class="Datatype Operator">⊎</a> <a id="7929" href="2016-03-01-insertion-sort-in-agda.html#7895" class="Bound">l</a> <a id="7931" href="Agda.Builtin.Equality.html#151" class="Datatype Operator">≡</a> <a id="7933" href="2016-03-01-insertion-sort-in-agda.html#3461" class="InductiveConstructor">⊥</a>
  <a id="7937" href="2016-03-01-insertion-sort-in-agda.html#7849" class="Function">fromVec-⊤or⊥</a> <a id="7950" class="Symbol">{</a><a id="7951" class="DottedPattern Symbol">.</a><a id="7952" class="DottedPattern Number">0</a><a id="7953" class="Symbol">}</a>       <a id="7961" class="Symbol">{</a><a id="7962" href="Data.Vec.Base.html#1034" class="InductiveConstructor">[]</a><a id="7964" class="Symbol">}</a>     <a id="7970" class="Symbol">=</a> <a id="7972" href="Data.Sum.Base.html#784" class="InductiveConstructor">inj₁</a> <a id="7977" href="Agda.Builtin.Equality.html#208" class="InductiveConstructor">refl</a>
  <a id="7984" href="2016-03-01-insertion-sort-in-agda.html#7849" class="Function">fromVec-⊤or⊥</a> <a id="7997" class="Symbol">{</a><a id="7998" class="DottedPattern Symbol">.(</a><a id="8000" href="Agda.Builtin.Nat.html#223" class="DottedPattern InductiveConstructor">suc</a> <a id="8004" class="DottedPattern Symbol">_)</a><a id="8006" class="Symbol">}</a> <a id="8008" class="Symbol">{</a><a id="8009" href="2016-03-01-insertion-sort-in-agda.html#8009" class="Bound">x</a> <a id="8011" href="Data.Vec.Base.html#1053" class="InductiveConstructor Operator">∷</a> <a id="8013" href="2016-03-01-insertion-sort-in-agda.html#8013" class="Bound">xs</a><a id="8015" class="Symbol">}</a> <a id="8017" class="Symbol">=</a> <a id="8019" href="Data.Sum.Base.html#809" class="InductiveConstructor">inj₂</a> <a id="8024" href="Agda.Builtin.Equality.html#208" class="InductiveConstructor">refl</a>
</pre>
And obviously, we can also turn any k-ordered vector into a regular vector simply by forgetting about all the order evidence:

<pre class="Agda">  <a id="InsertionSort.toVec"></a><a id="8167" href="2016-03-01-insertion-sort-in-agda.html#8167" class="Function">toVec</a> <a id="8173" class="Symbol">:</a> <a id="8175" class="Symbol">∀</a> <a id="8177" class="Symbol">{</a><a id="8178" href="2016-03-01-insertion-sort-in-agda.html#8178" class="Bound">l</a> <a id="8180" href="2016-03-01-insertion-sort-in-agda.html#8180" class="Bound">n</a> <a id="8182" href="2016-03-01-insertion-sort-in-agda.html#8182" class="Bound">k</a><a id="8183" class="Symbol">}</a> <a id="8185" class="Symbol">→</a> <a id="8187" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="8192" href="2016-03-01-insertion-sort-in-agda.html#8178" class="Bound">l</a> <a id="8194" href="2016-03-01-insertion-sort-in-agda.html#8180" class="Bound">n</a> <a id="8196" href="2016-03-01-insertion-sort-in-agda.html#8182" class="Bound">k</a> <a id="8198" class="Symbol">→</a> <a id="8200" href="Data.Vec.Base.html#998" class="Datatype">Vec</a> <a id="8204" href="2016-03-01-insertion-sort-in-agda.html#3078" class="Function">A</a> <a id="8206" href="2016-03-01-insertion-sort-in-agda.html#8180" class="Bound">n</a>
  <a id="8210" href="2016-03-01-insertion-sort-in-agda.html#8167" class="Function">toVec</a> <a id="8216" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a> <a id="8219" class="Symbol">=</a> <a id="8221" href="Data.Vec.Base.html#1034" class="InductiveConstructor">[]</a>
  <a id="8226" href="2016-03-01-insertion-sort-in-agda.html#8167" class="Function">toVec</a> <a id="8232" class="Symbol">(</a><a id="8233" href="2016-03-01-insertion-sort-in-agda.html#8233" class="Bound">x</a> <a id="8235" href="2016-03-01-insertion-sort-in-agda.html#7226" class="InductiveConstructor Operator">∷</a> <a id="8237" href="2016-03-01-insertion-sort-in-agda.html#8237" class="Bound">xs</a><a id="8239" class="Symbol">)</a> <a id="8241" class="Symbol">=</a> <a id="8243" href="2016-03-01-insertion-sort-in-agda.html#8233" class="Bound">x</a> <a id="8245" href="Data.Vec.Base.html#1053" class="InductiveConstructor Operator">∷</a> <a id="8247" href="2016-03-01-insertion-sort-in-agda.html#8167" class="Function">toVec</a> <a id="8253" href="2016-03-01-insertion-sort-in-agda.html#8237" class="Bound">xs</a>
  <a id="8258" href="2016-03-01-insertion-sort-in-agda.html#8167" class="Function">toVec</a> <a id="8264" class="Symbol">(</a><a id="8265" href="2016-03-01-insertion-sort-in-agda.html#8265" class="Bound">x</a> <a id="8267" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="8269" href="2016-03-01-insertion-sort-in-agda.html#8269" class="Bound">xs</a> <a id="8272" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="8275" class="Symbol">_)</a> <a id="8278" class="Symbol">=</a> <a id="8280" href="2016-03-01-insertion-sort-in-agda.html#8265" class="Bound">x</a> <a id="8282" href="Data.Vec.Base.html#1053" class="InductiveConstructor Operator">∷</a> <a id="8284" href="2016-03-01-insertion-sort-in-agda.html#8167" class="Function">toVec</a> <a id="8290" href="2016-03-01-insertion-sort-in-agda.html#8269" class="Bound">xs</a>
</pre>
Finally! We've developed enough vocabulary to write down what it really means to perform an insertion:

<pre class="Agda">  <a id="InsertionSort.insert"></a><a id="8408" href="2016-03-01-insertion-sort-in-agda.html#8408" class="Function">insert</a> <a id="8415" class="Symbol">:</a> <a id="8417" class="Symbol">∀</a> <a id="8419" class="Symbol">{</a><a id="8420" href="2016-03-01-insertion-sort-in-agda.html#8420" class="Bound">l</a> <a id="8422" href="2016-03-01-insertion-sort-in-agda.html#8422" class="Bound">n</a> <a id="8424" href="2016-03-01-insertion-sort-in-agda.html#8424" class="Bound">k</a><a id="8425" class="Symbol">}</a> <a id="8427" class="Symbol">(</a><a id="8428" href="2016-03-01-insertion-sort-in-agda.html#8428" class="Bound">x</a> <a id="8430" class="Symbol">:</a> <a id="8432" href="2016-03-01-insertion-sort-in-agda.html#3078" class="Function">A</a><a id="8433" class="Symbol">)</a> <a id="8435" class="Symbol">→</a> <a id="8437" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="8442" href="2016-03-01-insertion-sort-in-agda.html#8420" class="Bound">l</a> <a id="8444" href="2016-03-01-insertion-sort-in-agda.html#8422" class="Bound">n</a> <a id="8446" href="2016-03-01-insertion-sort-in-agda.html#8424" class="Bound">k</a> <a id="8448" class="Symbol">→</a> <a id="8450" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="8455" class="Symbol">(</a><a id="8456" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="8458" href="2016-03-01-insertion-sort-in-agda.html#8428" class="Bound">x</a> <a id="8460" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="8462" href="2016-03-01-insertion-sort-in-agda.html#4477" class="Function Operator">⊓</a> <a id="8464" href="2016-03-01-insertion-sort-in-agda.html#8420" class="Bound">l</a><a id="8465" class="Symbol">)</a> <a id="8467" class="Symbol">(</a><a id="8468" href="Agda.Builtin.Nat.html#223" class="InductiveConstructor">suc</a> <a id="8472" href="2016-03-01-insertion-sort-in-agda.html#8422" class="Bound">n</a><a id="8473" class="Symbol">)</a> <a id="8475" href="2016-03-01-insertion-sort-in-agda.html#8424" class="Bound">k</a>
  <a id="8479" href="2016-03-01-insertion-sort-in-agda.html#8408" class="Function">insert</a> <a id="8486" href="2016-03-01-insertion-sort-in-agda.html#8486" class="Bound">x</a> <a id="8488" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a>       <a id="8497" class="Symbol">=</a> <a id="8499" href="2016-03-01-insertion-sort-in-agda.html#8486" class="Bound">x</a> <a id="8501" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="8503" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a> <a id="8506" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="8509" href="2016-03-01-insertion-sort-in-agda.html#3765" class="InductiveConstructor">≲⊤</a>
  <a id="8514" href="2016-03-01-insertion-sort-in-agda.html#8408" class="Function">insert</a> <a id="8521" href="2016-03-01-insertion-sort-in-agda.html#8521" class="Bound">x</a> <a id="8523" class="Symbol">(</a><a id="8524" href="2016-03-01-insertion-sort-in-agda.html#8524" class="Bound">y</a> <a id="8526" href="2016-03-01-insertion-sort-in-agda.html#7226" class="InductiveConstructor Operator">∷</a> <a id="8528" href="2016-03-01-insertion-sort-in-agda.html#8528" class="Bound">xs</a><a id="8530" class="Symbol">)</a> <a id="8532" class="Symbol">=</a> <a id="8534" href="2016-03-01-insertion-sort-in-agda.html#8524" class="Bound">y</a> <a id="8536" href="2016-03-01-insertion-sort-in-agda.html#7226" class="InductiveConstructor Operator">∷</a> <a id="8538" href="2016-03-01-insertion-sort-in-agda.html#8408" class="Function">insert</a> <a id="8545" href="2016-03-01-insertion-sort-in-agda.html#8521" class="Bound">x</a> <a id="8547" href="2016-03-01-insertion-sort-in-agda.html#8528" class="Bound">xs</a>
  <a id="8552" href="2016-03-01-insertion-sort-in-agda.html#8408" class="Function">insert</a> <a id="8559" href="2016-03-01-insertion-sort-in-agda.html#8559" class="Bound">x</a> <a id="8561" class="Symbol">(</a><a id="8562" href="2016-03-01-insertion-sort-in-agda.html#8562" class="Bound">y</a> <a id="8564" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="8566" href="2016-03-01-insertion-sort-in-agda.html#8566" class="Bound">xs</a> <a id="8569" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="8572" href="2016-03-01-insertion-sort-in-agda.html#8572" class="Bound">p</a><a id="8573" class="Symbol">)</a> <a id="8575" class="Keyword">with</a> <a id="8580" href="2016-03-01-insertion-sort-in-agda.html#8559" class="Bound">x</a> <a id="8582" href="Relation.Binary.Structures.html#5772" class="Function Operator">≤?</a> <a id="8585" href="2016-03-01-insertion-sort-in-agda.html#8562" class="Bound">y</a>
  <a id="8589" class="Symbol">...</a> <a id="8593" class="Symbol">|</a> <a id="8595" href="Relation.Nullary.html#1648" class="InductiveConstructor">yes</a> <a id="8599" href="2016-03-01-insertion-sort-in-agda.html#8599" class="Bound">x≤y</a> <a id="8603" class="Symbol">=</a> <a id="8605" class="Bound">x</a> <a id="8607" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="8609" class="Symbol">(</a><a id="8610" class="Bound">y</a> <a id="8612" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="8614" class="Bound">xs</a> <a id="8617" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="8620" class="Bound">p</a><a id="8621" class="Symbol">)</a>
                  <a id="8641" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="8644" class="Symbol">(</a><a id="8645" href="2016-03-01-insertion-sort-in-agda.html#3788" class="InductiveConstructor">≤-lift</a> <a id="8652" href="2016-03-01-insertion-sort-in-agda.html#8599" class="Bound">x≤y</a><a id="8655" class="Symbol">)</a>
  <a id="8659" class="Symbol">...</a> <a id="8663" class="Symbol">|</a> <a id="8665" href="Relation.Nullary.html#1685" class="InductiveConstructor">no</a>  <a id="8669" href="2016-03-01-insertion-sort-in-agda.html#8669" class="Bound">x≰y</a> <a id="8673" class="Symbol">=</a> <a id="8675" class="Bound">y</a> <a id="8677" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="8679" class="Symbol">(</a><a id="8680" href="2016-03-01-insertion-sort-in-agda.html#8408" class="Function">insert</a> <a id="8687" class="Bound">x</a> <a id="8689" class="Bound">xs</a><a id="8691" class="Symbol">)</a>
                  <a id="8711" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="8714" class="Symbol">(</a><a id="8715" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="8729" class="Symbol">(</a><a id="8730" href="2016-03-01-insertion-sort-in-agda.html#4070" class="Function">≰-lift</a> <a id="8737" href="2016-03-01-insertion-sort-in-agda.html#8669" class="Bound">x≰y</a><a id="8740" class="Symbol">)</a> <a id="8742" class="Bound">p</a><a id="8743" class="Symbol">)</a>
</pre>
Note that insert takes a vector with *k* unsorted elements, and returns a vector which has one more element, but still only *k* unsorted elements! It does this (obviously) by inserting the element at the right position within the sorted portion of the vector.

It follows fairly easily from the fact that 'insert' inserts an element in the sorted portion of the vector, that if we take elements from the unsorted portion, insert it, and repeat this *k* times, we'll have sorted *k* elements… and therefore the list.

<pre class="Agda">  <a id="InsertionSort.insertsort"></a><a id="9273" href="2016-03-01-insertion-sort-in-agda.html#9273" class="Function">insertsort</a> <a id="9284" class="Symbol">:</a> <a id="9286" class="Symbol">∀</a> <a id="9288" class="Symbol">{</a><a id="9289" href="2016-03-01-insertion-sort-in-agda.html#9289" class="Bound">l</a> <a id="9291" href="2016-03-01-insertion-sort-in-agda.html#9291" class="Bound">n</a> <a id="9293" href="2016-03-01-insertion-sort-in-agda.html#9293" class="Bound">k</a><a id="9294" class="Symbol">}</a> <a id="9296" class="Symbol">→</a> <a id="9298" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="9303" href="2016-03-01-insertion-sort-in-agda.html#9289" class="Bound">l</a> <a id="9305" href="2016-03-01-insertion-sort-in-agda.html#9291" class="Bound">n</a> <a id="9307" href="2016-03-01-insertion-sort-in-agda.html#9293" class="Bound">k</a> <a id="9309" class="Symbol">→</a> <a id="9311" href="Data.Product.html#1369" class="Function">∃</a> <a id="9313" class="Symbol">(λ</a> <a id="9316" href="2016-03-01-insertion-sort-in-agda.html#9316" class="Bound">l</a> <a id="9318" class="Symbol">→</a> <a id="9320" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="9325" href="2016-03-01-insertion-sort-in-agda.html#9316" class="Bound">l</a> <a id="9327" href="2016-03-01-insertion-sort-in-agda.html#9291" class="Bound">n</a> <a id="9329" class="Number">0</a><a id="9330" class="Symbol">)</a>
  <a id="9334" href="2016-03-01-insertion-sort-in-agda.html#9273" class="Function">insertsort</a> <a id="9345" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a>            <a id="9359" class="Symbol">=</a> <a id="9361" href="2016-03-01-insertion-sort-in-agda.html#3450" class="InductiveConstructor">⊤</a> <a id="9363" href="Agda.Builtin.Sigma.html#236" class="InductiveConstructor Operator">,</a> <a id="9365" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a>
  <a id="9370" href="2016-03-01-insertion-sort-in-agda.html#9273" class="Function">insertsort</a> <a id="9381" class="Symbol">(</a><a id="9382" href="2016-03-01-insertion-sort-in-agda.html#9382" class="Bound">x</a> <a id="9384" href="2016-03-01-insertion-sort-in-agda.html#7226" class="InductiveConstructor Operator">∷</a> <a id="9386" href="2016-03-01-insertion-sort-in-agda.html#9386" class="Bound">xs</a><a id="9388" class="Symbol">)</a>      <a id="9395" class="Symbol">=</a> <a id="9397" href="2016-03-01-insertion-sort-in-agda.html#9273" class="Function">insertsort</a> <a id="9408" class="Symbol">(</a><a id="9409" href="2016-03-01-insertion-sort-in-agda.html#8408" class="Function">insert</a> <a id="9416" href="2016-03-01-insertion-sort-in-agda.html#9382" class="Bound">x</a> <a id="9418" href="2016-03-01-insertion-sort-in-agda.html#9386" class="Bound">xs</a><a id="9420" class="Symbol">)</a>
  <a id="9424" href="2016-03-01-insertion-sort-in-agda.html#9273" class="Function">insertsort</a> <a id="9435" class="Symbol">(</a><a id="9436" href="2016-03-01-insertion-sort-in-agda.html#9436" class="Bound">x</a> <a id="9438" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="9440" href="2016-03-01-insertion-sort-in-agda.html#9440" class="Bound">xs</a> <a id="9443" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="9446" href="2016-03-01-insertion-sort-in-agda.html#9446" class="Bound">p</a><a id="9447" class="Symbol">)</a> <a id="9449" class="Symbol">=</a> <a id="9451" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="9453" href="2016-03-01-insertion-sort-in-agda.html#9436" class="Bound">x</a> <a id="9455" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="9457" href="Agda.Builtin.Sigma.html#236" class="InductiveConstructor Operator">,</a> <a id="9459" href="2016-03-01-insertion-sort-in-agda.html#9436" class="Bound">x</a> <a id="9461" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="9463" href="2016-03-01-insertion-sort-in-agda.html#9440" class="Bound">xs</a> <a id="9466" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="9469" href="2016-03-01-insertion-sort-in-agda.html#9446" class="Bound">p</a>
</pre>
There is one thing we haven't verified so far---and I've hinted at this possibility above. It is fairly simple to implement an insertion sort algorithm with the *same* type which simply takes the first element and repeats it *n* times.

So our types aren't perfect. However, such constraints are a little harder to encode in data types. One approach would be to construct a sorting permutation instead of working with an input and output list. What we could do to make this code work is to give a separate proof---though this would go against my correctness by construction sensibilities---stating that if an element is in the input list it is in the output list. However, as I mostly wrote this blog post as a test case for my Jekyll/Agda integration… I'm not going to put in the effort to do either.

One amusing anecdote about this code is that while I was writing it, I thought I was implementing bubble sort---so much for safety. However, if you have a look at the invariants that both algorithms maintain, they are really quite similar. In fact, we can easily implement bubble sort using our `OVec` data type. The underlying algorithm is incredibly similar to insert. However, as opposed to inserting the first element in the correct position, "bubble" has trouble making up its mind and drops whatever it's holding when it sees a bigger element!

<pre class="Agda">  <a id="InsertionSort.bubble"></a><a id="10836" href="2016-03-01-insertion-sort-in-agda.html#10836" class="Function">bubble</a> <a id="10843" class="Symbol">:</a> <a id="10845" class="Symbol">∀</a> <a id="10847" class="Symbol">{</a><a id="10848" href="2016-03-01-insertion-sort-in-agda.html#10848" class="Bound">l</a> <a id="10850" href="2016-03-01-insertion-sort-in-agda.html#10850" class="Bound">n</a> <a id="10852" href="2016-03-01-insertion-sort-in-agda.html#10852" class="Bound">k</a><a id="10853" class="Symbol">}</a> <a id="10855" class="Symbol">(</a><a id="10856" href="2016-03-01-insertion-sort-in-agda.html#10856" class="Bound">x</a> <a id="10858" class="Symbol">:</a> <a id="10860" href="2016-03-01-insertion-sort-in-agda.html#3078" class="Function">A</a><a id="10861" class="Symbol">)</a> <a id="10863" class="Symbol">→</a> <a id="10865" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="10870" href="2016-03-01-insertion-sort-in-agda.html#10848" class="Bound">l</a> <a id="10872" href="2016-03-01-insertion-sort-in-agda.html#10850" class="Bound">n</a> <a id="10874" href="2016-03-01-insertion-sort-in-agda.html#10852" class="Bound">k</a> <a id="10876" class="Symbol">→</a> <a id="10878" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="10883" class="Symbol">(</a><a id="10884" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="10886" href="2016-03-01-insertion-sort-in-agda.html#10856" class="Bound">x</a> <a id="10888" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="10890" href="2016-03-01-insertion-sort-in-agda.html#4477" class="Function Operator">⊓</a> <a id="10892" href="2016-03-01-insertion-sort-in-agda.html#10848" class="Bound">l</a><a id="10893" class="Symbol">)</a> <a id="10895" class="Symbol">(</a><a id="10896" href="Agda.Builtin.Nat.html#223" class="InductiveConstructor">suc</a> <a id="10900" href="2016-03-01-insertion-sort-in-agda.html#10850" class="Bound">n</a><a id="10901" class="Symbol">)</a> <a id="10903" href="2016-03-01-insertion-sort-in-agda.html#10852" class="Bound">k</a>
  <a id="10907" href="2016-03-01-insertion-sort-in-agda.html#10836" class="Function">bubble</a> <a id="10914" href="2016-03-01-insertion-sort-in-agda.html#10914" class="Bound">x</a> <a id="10916" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a>            <a id="10930" class="Symbol">=</a> <a id="10932" href="2016-03-01-insertion-sort-in-agda.html#10914" class="Bound">x</a> <a id="10934" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="10936" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a> <a id="10939" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="10942" href="2016-03-01-insertion-sort-in-agda.html#3765" class="InductiveConstructor">≲⊤</a>
  <a id="10947" href="2016-03-01-insertion-sort-in-agda.html#10836" class="Function">bubble</a> <a id="10954" href="2016-03-01-insertion-sort-in-agda.html#10954" class="Bound">x</a> <a id="10956" class="Symbol">(</a><a id="10957" href="2016-03-01-insertion-sort-in-agda.html#10957" class="Bound">y</a> <a id="10959" href="2016-03-01-insertion-sort-in-agda.html#7226" class="InductiveConstructor Operator">∷</a> <a id="10961" href="2016-03-01-insertion-sort-in-agda.html#10961" class="Bound">xs</a><a id="10963" class="Symbol">)</a>      <a id="10970" class="Keyword">with</a> <a id="10975" href="2016-03-01-insertion-sort-in-agda.html#10954" class="Bound">x</a> <a id="10977" href="Relation.Binary.Structures.html#5772" class="Function Operator">≤?</a> <a id="10980" href="2016-03-01-insertion-sort-in-agda.html#10957" class="Bound">y</a>
  <a id="10984" class="Symbol">...</a> <a id="10988" class="Symbol">|</a> <a id="10990" href="Relation.Nullary.html#1685" class="InductiveConstructor">no</a>  <a id="10994" href="2016-03-01-insertion-sort-in-agda.html#10994" class="Bound">x≰y</a> <a id="10998" class="Symbol">=</a> <a id="11000" class="Bound">y</a> <a id="11002" href="2016-03-01-insertion-sort-in-agda.html#7226" class="InductiveConstructor Operator">∷</a> <a id="11004" href="2016-03-01-insertion-sort-in-agda.html#10836" class="Function">bubble</a> <a id="11011" class="Bound">x</a> <a id="11013" class="Bound">xs</a>
  <a id="11018" class="Symbol">...</a> <a id="11022" class="Symbol">|</a> <a id="11024" href="Relation.Nullary.html#1648" class="InductiveConstructor">yes</a> <a id="11028" href="2016-03-01-insertion-sort-in-agda.html#11028" class="Bound">x≤y</a> <a id="11032" class="Symbol">=</a> <a id="11034" class="Bound">x</a> <a id="11036" href="2016-03-01-insertion-sort-in-agda.html#7226" class="InductiveConstructor Operator">∷</a> <a id="11038" href="2016-03-01-insertion-sort-in-agda.html#10836" class="Function">bubble</a> <a id="11045" class="Bound">y</a> <a id="11047" class="Bound">xs</a>
  <a id="11052" href="2016-03-01-insertion-sort-in-agda.html#10836" class="Function">bubble</a> <a id="11059" href="2016-03-01-insertion-sort-in-agda.html#11059" class="Bound">x</a> <a id="11061" class="Symbol">(</a><a id="11062" href="2016-03-01-insertion-sort-in-agda.html#11062" class="Bound">y</a> <a id="11064" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="11066" href="2016-03-01-insertion-sort-in-agda.html#11066" class="Bound">xs</a> <a id="11069" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="11072" href="2016-03-01-insertion-sort-in-agda.html#11072" class="Bound">p</a><a id="11073" class="Symbol">)</a> <a id="11075" class="Keyword">with</a> <a id="11080" href="2016-03-01-insertion-sort-in-agda.html#11059" class="Bound">x</a> <a id="11082" href="Relation.Binary.Structures.html#5772" class="Function Operator">≤?</a> <a id="11085" href="2016-03-01-insertion-sort-in-agda.html#11062" class="Bound">y</a>
  <a id="11089" class="Symbol">...</a> <a id="11093" class="Symbol">|</a> <a id="11095" href="Relation.Nullary.html#1685" class="InductiveConstructor">no</a>  <a id="11099" href="2016-03-01-insertion-sort-in-agda.html#11099" class="Bound">x≰y</a> <a id="11103" class="Symbol">=</a> <a id="11105" class="Bound">y</a> <a id="11107" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="11109" href="2016-03-01-insertion-sort-in-agda.html#10836" class="Function">bubble</a> <a id="11116" class="Bound">x</a> <a id="11118" class="Bound">xs</a>
                  <a id="11139" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="11142" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="11156" class="Symbol">(</a><a id="11157" href="2016-03-01-insertion-sort-in-agda.html#4070" class="Function">≰-lift</a> <a id="11164" href="2016-03-01-insertion-sort-in-agda.html#11099" class="Bound">x≰y</a><a id="11167" class="Symbol">)</a> <a id="11169" class="Bound">p</a>
  <a id="11173" class="Symbol">...</a> <a id="11177" class="Symbol">|</a> <a id="11179" href="Relation.Nullary.html#1648" class="InductiveConstructor">yes</a> <a id="11183" href="2016-03-01-insertion-sort-in-agda.html#11183" class="Bound">x≤y</a> <a id="11187" class="Symbol">=</a> <a id="11189" class="Bound">x</a> <a id="11191" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="11193" href="2016-03-01-insertion-sort-in-agda.html#10836" class="Function">bubble</a> <a id="11200" class="Bound">y</a> <a id="11202" class="Bound">xs</a>
                  <a id="11223" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="11226" href="2016-03-01-insertion-sort-in-agda.html#4643" class="Function">⊓-conserves-≲</a> <a id="11240" href="2016-03-01-insertion-sort-in-agda.html#11276" class="Function">x≲y</a> <a id="11244" class="Symbol">(</a><a id="11245" href="2016-03-01-insertion-sort-in-agda.html#11600" class="Function">≲-trans</a> <a id="11253" href="2016-03-01-insertion-sort-in-agda.html#11276" class="Function">x≲y</a> <a id="11257" class="Bound">p</a><a id="11258" class="Symbol">)</a>
    <a id="11264" class="Keyword">where</a>
      <a id="11276" href="2016-03-01-insertion-sort-in-agda.html#11276" class="Function">x≲y</a> <a id="11280" class="Symbol">=</a> <a id="11282" href="2016-03-01-insertion-sort-in-agda.html#3788" class="InductiveConstructor">≤-lift</a> <a id="11289" href="2016-03-01-insertion-sort-in-agda.html#11183" class="Bound">x≤y</a>
</pre>
All that we need is to show that our home-brewed ≲-relation is transitive. This follows immediately from the underlying order. This kind of stuff---the adding of bounds to total order---should really be provided by the standard library. And perhaps it is, and I've simply failed to find it…

<pre class="Agda">      <a id="11600" href="2016-03-01-insertion-sort-in-agda.html#11600" class="Function">≲-trans</a> <a id="11608" class="Symbol">:</a> <a id="11610" class="Symbol">∀</a> <a id="11612" class="Symbol">{</a><a id="11613" href="2016-03-01-insertion-sort-in-agda.html#11613" class="Bound">x</a> <a id="11615" href="2016-03-01-insertion-sort-in-agda.html#11615" class="Bound">y</a> <a id="11617" href="2016-03-01-insertion-sort-in-agda.html#11617" class="Bound">z</a><a id="11618" class="Symbol">}</a> <a id="11620" class="Symbol">→</a> <a id="11622" href="2016-03-01-insertion-sort-in-agda.html#11613" class="Bound">x</a> <a id="11624" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="11626" href="2016-03-01-insertion-sort-in-agda.html#11615" class="Bound">y</a> <a id="11628" class="Symbol">→</a> <a id="11630" href="2016-03-01-insertion-sort-in-agda.html#11615" class="Bound">y</a> <a id="11632" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="11634" href="2016-03-01-insertion-sort-in-agda.html#11617" class="Bound">z</a> <a id="11636" class="Symbol">→</a> <a id="11638" href="2016-03-01-insertion-sort-in-agda.html#11613" class="Bound">x</a> <a id="11640" href="2016-03-01-insertion-sort-in-agda.html#3710" class="Datatype Operator">≲</a> <a id="11642" href="2016-03-01-insertion-sort-in-agda.html#11617" class="Bound">z</a>
      <a id="11650" href="2016-03-01-insertion-sort-in-agda.html#11600" class="Function">≲-trans</a>  <a id="11659" href="2016-03-01-insertion-sort-in-agda.html#3742" class="InductiveConstructor">⊥≲</a>         <a id="11670" class="Symbol">_</a>         <a id="11680" class="Symbol">=</a> <a id="11682" href="2016-03-01-insertion-sort-in-agda.html#3742" class="InductiveConstructor">⊥≲</a>
      <a id="11691" href="2016-03-01-insertion-sort-in-agda.html#11600" class="CatchallClause Function">≲-trans</a><a id="11698" class="CatchallClause">  </a><a id="11700" class="CatchallClause Symbol">_</a><a id="11701" class="CatchallClause">          </a><a id="11711" href="2016-03-01-insertion-sort-in-agda.html#3765" class="CatchallClause InductiveConstructor">≲⊤</a>        <a id="11721" class="Symbol">=</a> <a id="11723" href="2016-03-01-insertion-sort-in-agda.html#3765" class="InductiveConstructor">≲⊤</a>
      <a id="11732" href="2016-03-01-insertion-sort-in-agda.html#11600" class="Function">≲-trans</a> <a id="11740" class="Symbol">(</a><a id="11741" href="2016-03-01-insertion-sort-in-agda.html#3788" class="InductiveConstructor">≤-lift</a> <a id="11748" href="2016-03-01-insertion-sort-in-agda.html#11748" class="Bound">p</a><a id="11749" class="Symbol">)</a> <a id="11751" class="Symbol">(</a><a id="11752" href="2016-03-01-insertion-sort-in-agda.html#3788" class="InductiveConstructor">≤-lift</a> <a id="11759" href="2016-03-01-insertion-sort-in-agda.html#11759" class="Bound">q</a><a id="11760" class="Symbol">)</a> <a id="11762" class="Symbol">=</a> <a id="11764" href="2016-03-01-insertion-sort-in-agda.html#3788" class="InductiveConstructor">≤-lift</a> <a id="11771" class="Symbol">(</a><a id="11772" href="2016-03-01-insertion-sort-in-agda.html#3067" class="Function">≤-trans</a> <a id="11780" href="2016-03-01-insertion-sort-in-agda.html#11748" class="Bound">p</a> <a id="11782" href="2016-03-01-insertion-sort-in-agda.html#11759" class="Bound">q</a><a id="11783" class="Symbol">)</a>
</pre>
At any rate, once we have our "bubble" function, the implementation of
the sorting algorithm is trivial---and exactly identical to the
definition of insertion sort!

<pre class="Agda">  <a id="InsertionSort.bubblesort"></a><a id="11962" href="2016-03-01-insertion-sort-in-agda.html#11962" class="Function">bubblesort</a> <a id="11973" class="Symbol">:</a> <a id="11975" class="Symbol">∀</a> <a id="11977" class="Symbol">{</a><a id="11978" href="2016-03-01-insertion-sort-in-agda.html#11978" class="Bound">l</a> <a id="11980" href="2016-03-01-insertion-sort-in-agda.html#11980" class="Bound">n</a> <a id="11982" href="2016-03-01-insertion-sort-in-agda.html#11982" class="Bound">k</a><a id="11983" class="Symbol">}</a> <a id="11985" class="Symbol">→</a> <a id="11987" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="11992" href="2016-03-01-insertion-sort-in-agda.html#11978" class="Bound">l</a> <a id="11994" href="2016-03-01-insertion-sort-in-agda.html#11980" class="Bound">n</a> <a id="11996" href="2016-03-01-insertion-sort-in-agda.html#11982" class="Bound">k</a> <a id="11998" class="Symbol">→</a> <a id="12000" href="Data.Product.html#1369" class="Function">∃</a> <a id="12002" class="Symbol">(λ</a> <a id="12005" href="2016-03-01-insertion-sort-in-agda.html#12005" class="Bound">l</a> <a id="12007" class="Symbol">→</a> <a id="12009" href="2016-03-01-insertion-sort-in-agda.html#7055" class="Datatype">OVec</a> <a id="12014" href="2016-03-01-insertion-sort-in-agda.html#12005" class="Bound">l</a> <a id="12016" href="2016-03-01-insertion-sort-in-agda.html#11980" class="Bound">n</a> <a id="12018" class="Number">0</a><a id="12019" class="Symbol">)</a>
  <a id="12023" href="2016-03-01-insertion-sort-in-agda.html#11962" class="Function">bubblesort</a> <a id="12034" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a>            <a id="12048" class="Symbol">=</a> <a id="12050" href="2016-03-01-insertion-sort-in-agda.html#3450" class="InductiveConstructor">⊤</a> <a id="12052" href="Agda.Builtin.Sigma.html#236" class="InductiveConstructor Operator">,</a> <a id="12054" href="2016-03-01-insertion-sort-in-agda.html#7107" class="InductiveConstructor">[]</a>
  <a id="12059" href="2016-03-01-insertion-sort-in-agda.html#11962" class="Function">bubblesort</a> <a id="12070" class="Symbol">(</a><a id="12071" href="2016-03-01-insertion-sort-in-agda.html#12071" class="Bound">x</a> <a id="12073" href="2016-03-01-insertion-sort-in-agda.html#7226" class="InductiveConstructor Operator">∷</a> <a id="12075" href="2016-03-01-insertion-sort-in-agda.html#12075" class="Bound">xs</a><a id="12077" class="Symbol">)</a>      <a id="12084" class="Symbol">=</a> <a id="12086" href="2016-03-01-insertion-sort-in-agda.html#11962" class="Function">bubblesort</a> <a id="12097" class="Symbol">(</a><a id="12098" href="2016-03-01-insertion-sort-in-agda.html#10836" class="Function">bubble</a> <a id="12105" href="2016-03-01-insertion-sort-in-agda.html#12071" class="Bound">x</a> <a id="12107" href="2016-03-01-insertion-sort-in-agda.html#12075" class="Bound">xs</a><a id="12109" class="Symbol">)</a>
  <a id="12113" href="2016-03-01-insertion-sort-in-agda.html#11962" class="Function">bubblesort</a> <a id="12124" class="Symbol">(</a><a id="12125" href="2016-03-01-insertion-sort-in-agda.html#12125" class="Bound">x</a> <a id="12127" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="12129" href="2016-03-01-insertion-sort-in-agda.html#12129" class="Bound">xs</a> <a id="12132" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="12135" href="2016-03-01-insertion-sort-in-agda.html#12135" class="Bound">p</a><a id="12136" class="Symbol">)</a> <a id="12138" class="Symbol">=</a> <a id="12140" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟦</a> <a id="12142" href="2016-03-01-insertion-sort-in-agda.html#12125" class="Bound">x</a> <a id="12144" href="2016-03-01-insertion-sort-in-agda.html#3472" class="InductiveConstructor Operator">⟧</a> <a id="12146" href="Agda.Builtin.Sigma.html#236" class="InductiveConstructor Operator">,</a> <a id="12148" href="2016-03-01-insertion-sort-in-agda.html#12125" class="Bound">x</a> <a id="12150" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">∷</a> <a id="12152" href="2016-03-01-insertion-sort-in-agda.html#12129" class="Bound">xs</a> <a id="12155" href="2016-03-01-insertion-sort-in-agda.html#7132" class="InductiveConstructor Operator">by</a> <a id="12158" href="2016-03-01-insertion-sort-in-agda.html#12135" class="Bound">p</a>
</pre>
This does lead to an interesting point: how do you know that what you've implemented is actually what you *wanted* to implement? Of course, a similar discussion applies much more strongly to programming languages with weaker or non-existent type systems. However, the point seems to be brought up more often once you stray into the realm of verification.

Obviously, if you write your program in a language such as JavaScript, there is nothing that tells you you've implemented the right algorithm. And it would be rather hard to come up with a test which could tell the difference between insertion sort and bubble sort---though a stress-test may reveal the fact. However, in JavaScript, one cannot even tell the difference between two completely different algorithms, e.g. "insertion sort" and "Lehvenstein distance", without using tests. And even then, tests generally only cover a small, finite number of cases. You may have implemented algorithm *A* for the first 100 inputs, and algorithm *B* afterwards, and you'll never know.

Once you enter the realm of Agda, the argument can be made a little neater: using a language with a *strong* type system, you limit the set of all possible algorithms with your types, and you can be sure that you've implemented *one* of the algorithms in that set. The trick is to narrow down the set to exactly those algorithms that you need.

In the above exercise, I failed to do so. The set of algorithms that I selected for was the set of algorithms that turn lists into sorted lists of equal length, without inspecting the values (other than by comparison) and maintaining the "*k*-unsorted elements" invariant. As we've seen, some of the algorithms in this set are insertion sort, bubble sort, and "copy the first element *n* times". And because I paid little attention---I'm convinced my brain simply implemented what was an obvious optimalisation---I picked the wrong one.

The second question that usually follows is "How do you know that you've written down the right *property*?" For instance, one small mistake in my definition of `OVec` would have it mean "a list where sometimes an element is smaller than one of the elements after it". Obviously, sorting algorithms would have this property… Now, the simple answer is that you don't. And this holds for Agda, Coq, JavaScript, set theory… There is no real way to ensure that what you write down, in general, corresponds to what you wanted to write down.

But there is one redeeming factor. Set theory is believed to not be a hot mess because there are *tons* of people who've checked the proofs, and who've used the proved properties to prove other, more complex properties. When you prove a lemma, you intend to *use* it to prove some different lemma. And in general, if you've proven the wrong lemma, your next proof will *fail*. And obviously, the notion that the *usage* of properties and and *repeated checking* of proofs strengthens a theory applies even more strongly to theories which are also *machine-checked*.
